<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>math.js | Lorenz Attractor</title>
    <script src="../../lib/browser/math.js"></script>

    <script src="https://cdn.plot.ly/plotly-2.28.0.min.js" charset="utf-8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js"
        integrity="sha512-LQNxIMR5rXv7o+b1l8+N1EZMfhG7iFZ9HhnbJkTp4zjNr5Wvst75AqUeFDxeRUa7l5vEDyUiAip//r+EFLLCyA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css"
        integrity="sha512-fHwaWebuwA7NSF5Qg/af4UeDx9XqUpYpOGgubo3yWu+b2IQR4UeQwbb42Ti7gVAjNtVoI/I9TEoYeu9omwcC6g=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>

<body>
    <h1>Lorenz Attractor</h1>
    <div id="LorenzGraph"></div>
    <div id="inputsDiv">
        <fieldset name="inputs" id="inputs">
            <legend for="inputs">Inputs:</legend>
            <label for="sigma" id="sigmaLabel">sigma</label>
            <input type="range" id="sigma" name="sigma" value=10 min=9 max=11 step=0.01><br />
            <label for="beta" id="betaLabel">beta</label>
            <input type="range" id="beta" name="beta" value=8/3 min=2 max=4 step=0.01><br />
            <label for="rho" id="rhoLabel">rho</label>
            <input type="range" id="rho" name="rho" value=28 min=20 max=30 step=0.01>
        </fieldset>
    </div>
    <div id="LorenzEquation">(dx/dt) = sigma(y-x); (dy/dt) = x(rho-z)-y; (dz/dt) = x*y - beta*z</div>
</body>
<script defer>
    katex.render("{\\begin{aligned}{\\frac {\\mathrm {d} x}{\\mathrm {d} t}}&=\\sigma (y-x),\\\\{\\frac {\\mathrm {d} y}{\\mathrm {d} t}}&=x(\\rho -z)-y,\\\\{\\frac {\\mathrm {d} z}{\\mathrm {d} t}}&=xy-\\beta z.\\end{aligned}}", document.querySelector("#LorenzEquation"))
    katex.render("\\sigma", document.querySelector("#sigmaLabel"))
    katex.render("\\beta", document.querySelector("#betaLabel"))
    katex.render("\\rho", document.querySelector("#rhoLabel"))

    const inputs = document.querySelector("#inputs")

    // define the constants for the Lorenz attractor
    const sigma = document.querySelector("#sigma")
    const beta = document.querySelector("#beta")
    const rho = document.querySelector("#rho")

    const layout = {
        uirevision: 'true', height: 600
    }

    const t_span = [0, 100]
    const y_0 = [1, 1, 1]

    inputs.addEventListener("change", updateSolution)

    // solve the Lorenz attractor with the initial values
    let sol = math.solveODE(createLorenz(sigma.value, rho.value, beta.value), t_span, y_0)
    let trace = createTrace(sol)
    updateSolution()

    // crates a trace in the format needed for plotly
    function createTrace(sol) {
        // make colors that represents time differences in the solution
        const diff = math.diff(sol.t)
        const color = [diff[0], ...diff]
        const trace = [{
            x: sol.y.map(u => u[0]),
            y: sol.y.map(u => u[1]),
            z: sol.y.map(u => u[2]),
            line: {
                color,
                colorscale: 'Jet'
            },
            type: "scatter3d",
            mode: "lines"
        }]
        return trace
    }

    function createLorenz(sigma, rho, beta) {
        // define the lorenz attractor as a function of t and u in the format needed for solveODE
        return function lorenz(t, u) {
            const [x, y, z] = u
            // return x', y', z'
            return [
                sigma * (y - x),
                x * (rho - z) - y,
                x * y - beta * z
            ]
        }
    }

    function updateSolution() {
        sol = math.solveODE(createLorenz(sigma.value, rho.value, beta.value), t_span, y_0)
        trace = createTrace(sol)
        // reactively render the plot on update
        Plotly.react('LorenzGraph', trace, layout)
    }

</script>

</html>
